---
title: Hindsight is 2020
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    orientation: rows
  # html_document:
    theme: "journal"
    # template: https://raw.githubusercontent.com/rstudio/rmarkdown/3a502fa8e85425aa7af723c1b4d2eecda9d7c632/inst/rmd/h/default.html
runtime: shiny
css: custom.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
source("helper.R")
library(tidyverse)
```

Home
================================================

### About

This interactive tool aims to supplement a semester-long project in which I forecasted the 2020 Presidential Election. The below interactive tools present and contextualize my predictions in a more visual manner than I did in my blog posts. Feel free to scroll through and enjoy! This page is largely inspired by the [FiveThirtyEight](https://projects.fivethirtyeight.com/2020-election-forecast/) forecast. Nate Silver, if you're seeing this, please hire me! See my full election blog and forecast write-up [here](https://kayla-manning.github.io/gov1347/).

Row
-------------------------------------------------

### Actual Results

```{r actual_gauge}

radioButtons("actual_scenario",
            "",
            c("Electoral Votes", "Two-Party Popular Vote"))

biden_actual_pv2p <- enos_data %>% 
  summarise(democrat = sum(democrat),
            republican = sum(republican)) %>% 
  summarise(democrat = round(democrat / (democrat + republican) * 100, 3)) %>% 
  pull(democrat)

# Biden gauge

renderGauge(

  gauge(ifelse(input$actual_scenario == "Electoral Votes", 306, 
               biden_actual_pv2p), 
        min = 0, 
        max = ifelse(input$actual_scenario == "Electoral Votes", 538, 100),
        gaugeSectors(
          success = ifelse(input$actual_scenario == "Electoral Votes", 
                           c(270, 538),
                           c(50.1, 100)), 
          warning = ifelse(input$actual_scenario == "Electoral Votes", 
                           c(269, 269),
                           c(50, 50)), 
          danger = ifelse(input$actual_scenario == "Electoral Votes", 
                          c(0, 268),
                           c(0, 49.9))), 
        label = ifelse(input$actual_scenario == "Electoral Votes", 
                       "Electoral Votes \for Biden", 
                       "Two-Party Popular Vote \for Biden"))
)

# Trump gauge

renderGauge(
  
  gauge(ifelse(input$actual_scenario == "Electoral Votes", 232, 
               100 - biden_actual_pv2p),
        min = 0, 
        max = ifelse(input$actual_scenario == "Electoral Votes", 538, 100),
        gaugeSectors(
          success = ifelse(input$actual_scenario == "Electoral Votes", 
                           c(270, 538),
                           c(50.1, 100)), 
          warning = ifelse(input$actual_scenario == "Electoral Votes", 
                           c(269, 269),
                           c(50, 50)), 
          danger = ifelse(input$actual_scenario == "Electoral Votes", c(0, 268),
                           c(0, 49.9))), 
        label = ifelse(input$actual_scenario == "Electoral Votes", 
                       "Electoral Votes \for Trump", 
                       "Two-Party Popular Vote \for Trump"))
)

```


### Predicted Results

```{r predicted_gauge}

radioButtons("pred_scenario",
            "",
            c("Electoral Votes", "Two-Party Popular Vote"))

biden_actual_pv2p <- enos_data %>% 
  summarise(democrat = sum(democrat),
            republican = sum(republican)) %>% 
  summarise(democrat = round(democrat / (democrat + republican) * 100, 3)) %>% 
  pull(democrat)

# Biden gauge

renderGauge(

  gauge(ifelse(input$pred_scenario == "Electoral Votes", 273, 52.720), 
        min = 0, 
        max = ifelse(input$pred_scenario == "Electoral Votes", 538, 100),
        gaugeSectors(
          success = ifelse(input$pred_scenario == "Electoral Votes", c(270, 538),
                           c(50.1, 100)), 
          warning = ifelse(input$pred_scenario == "Electoral Votes", c(269, 269),
                           c(50, 50)), 
          danger = ifelse(input$pred_scenario == "Electoral Votes", c(0, 268),
                           c(0, 49.9))), 
        label = ifelse(input$pred_scenario == "Electoral Votes", 
                       "Electoral Votes \for Biden", 
                       "Two-Party Popular Vote \for Biden"))
)

# Trump gauge

renderGauge(
  
  gauge(ifelse(input$pred_scenario == "Electoral Votes", 265, 100 - 52.120),
        min = 0, 
        max = ifelse(input$pred_scenario == "Electoral Votes", 538, 100),
        gaugeSectors(
          success = ifelse(input$pred_scenario == "Electoral Votes", c(270, 538),
                           c(50.1, 100)), 
          warning = ifelse(input$pred_scenario == "Electoral Votes", c(269, 269),
                           c(50, 50)), 
          danger = ifelse(input$pred_scenario == "Electoral Votes", c(0, 268),
                           c(0, 49.9))), 
        label = ifelse(input$pred_scenario == "Electoral Votes", 
                       "Electoral Votes \for Trump", 
                       "Two-Party Popular Vote \for Trump"))
)

```


Maps
================================================

The top map displays my Joe Biden's predicted two-party vote share, and the bottom displays the actual result. Hover over each state to see the state name and the exact number.

-------------------------------------------------

```{r pred_map, warning=FALSE}

pred_map <- ggplotly(pred_compare %>% 
  left_join(us_map, by = c("state" = "region")) %>% 
  ggplot(aes(long, lat, group = group, text = paste0("Biden's Predicted Two-Party \nVote Share in ", 
                                                     state, ": ", round(pred_pv2p, 3), "%"))) +
  geom_polygon(aes(fill = pred_pv2p)) +
  scale_fill_gradient2(low = "#BE1E26", high = "#4B5973",
                       midpoint = 50,
                       breaks = c(30, 50, 70),
                       labels = c(30, 50, 70),
                       limits = c(25, 75)) +
  coord_map() +
  labs(x = "",
       y = "",
       fill = "Biden's Two-Party \nVote Share",
       title = "Predicted Results") +
  theme_hodp() +
  theme(axis.line = element_blank(),
        axis.text = element_blank(),
        axis.text.x = element_blank()),
  tooltip = "text")

renderPlotly(pred_map)

```

-------------------------------------------------

```{r actual_map}

actual_map <- ggplotly(pred_compare %>% 
  left_join(us_map, by = c("state" = "region")) %>% 
  ggplot(aes(long, lat, group = group, text = paste0("Biden's Actual Two-Party \nVote Share in ", 
                                                     state, ": ", round(actual_pv2p, 3), "%"))) +
  geom_polygon(aes(fill = actual_pv2p)) +
  scale_fill_gradient2(low = "#BE1E26", high = "#4B5973",
                       midpoint = 50,
                       breaks = c(30, 50, 70),
                       labels = c(30, 50, 70),
                       limits = c(25, 75)) +
  coord_map() +
  labs(x = "",
       y = "",
       fill = "Biden's Two-Party \nVote Share",
       title = "Actual Results") +
  theme_hodp() +
  theme(axis.line = element_blank(),
        axis.text = element_blank(),
        axis.text.x = element_blank()),
  tooltip = "text")

renderPlotly(
  actual_map
)

```

###

```{r error_table, max.height='100px'}

pred_compare %>% 
  mutate(actual_pv2p = paste0(round(actual_pv2p, 3), "%"),
         pred_pv2p = paste0(round(pred_pv2p, 3), "%"),
         diff = paste0(round(diff, 3), "%")) %>% 
  select(-2)  %>% 
  kable(col.names = c("State", "Actual Two-Party \nPopular Vote",
                "Predicted Two-Party \nPopular Vote", "Actual - Predicted")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))

```


Simulation Results
=================================================

Nationwide Simulations {.tabset}
-------------------------------------------------

### Simulated Electoral Counts 

```{r national_ev}

ev_sims_plot <- ev_sims %>% 
  pivot_longer(cols = 2:3, names_to = "candidate", values_to = "ev") %>% 
  filter(candidate == "trump_ev") %>% 
  mutate(result = case_when(ev < 269 ~ "Biden",
                            ev >= 270 ~ "Trump",
                            ev == 269 ~ "Tie")) %>% 
  ggplot(aes(ev, text = paste0("Probability: ", round(after_stat(count / sum(count)), 3)))) +
    geom_density(aes(ev, ..density..), 
                 inherit.aes = FALSE) +
    geom_histogram(aes(y = after_stat(count / sum(count)), fill = result), 
                   binwidth = 1, position = "identity", alpha = 0.75) +
    labs(title = "",
         x = "Donald Trump's Electoral Votes",
         y = "Proportion of Simulations",
         fill = "Winner",
         subtitle = "Donald Trump Wins the Electoral College in 35.074% of Simulations") +
    geom_vline(xintercept = 232, size = 1)  +
  scale_fill_manual(breaks = c("Biden", "Trump", "Tie"),
                    values = c(my_blue, my_red, "gray"),
                    labels = c("Biden", "Trump", "Tie")) +
  theme_hodp()

renderPlotly(
  ggplotly(ev_sims_plot, tooltip = "text") %>% 
    add_annotations(text = "Actual Outcome", x = 232, y = 0.015, textangle = 270)
)
    

```

### Simulated Two-Party Vote Share

```{r nationwide_pv2p}

pv2p_sims_plot <- sims %>% 
  mutate(group = rep(1:100000, times = 50)) %>% 
  group_by(group) %>% 
  summarize(total_dem = sum(sim_dvotes_2020),
         total_rep = sum(sim_rvotes_2020),
         d_pv2p = total_dem / (total_dem + total_rep),
         r_pv2p = 1 - d_pv2p,
         .groups = "drop") %>% 
  pivot_longer(cols = 4:5, names_to = "party") %>% 
  ggplot(aes(value, fill = party)) +
  geom_histogram(aes(y = after_stat(count / sum(count))), bins = 1000, position = "identity", alpha = 0.95) +
  geom_vline(xintercept = biden_actual_pv2p / 100) +
  geom_vline(xintercept = 1 - biden_actual_pv2p / 100) +
  theme_minimal() +
  scale_fill_manual(breaks = c("d_pv2p", "r_pv2p"),
                    labels = c("Biden", "Trump"),
                    values = c(my_blue, my_red)) +
  labs(title = "",
       x = "Predicted Share of the Two-Party Popular Vote",
       y = "Count",
       subtitle = "Donald Trump Wins the Popular Vote in 0.049% of Simulations",
       fill = "Candidate") +
  theme_hodp()

renderPlotly(
  ggplotly(pv2p_sims_plot) %>% 
    add_annotations(text = "Trump Actual Outcome", x = 0.48, y = 0.002, textangle = 270) %>% 
    add_annotations(text = "Biden Actual Outcome", x = 0.525, y = 0.002, textangle = 90)
)  
```

State-Level Predictions
=================================================

State-Level Predicted Vote Shares and Probabilities of Victory {.tabset}
-------------------------------------------------

### Vote Shares

```{r state_predicted_pv}
selectInput("state_type_pv",
            "State Category:",
            types %>% pull(type) %>% unique())
renderPlotly(
  state_voteshares(input$state_type_pv)
)
```

### Win Probabilities

```{r state_win_probs}
selectInput("state_type_win",
            "State Category:",
            types %>% pull(type) %>% unique())
renderPlotly(
  state_win_probs(input$state_type_win)
)
```

-------------------------------------------------

### State-Level Two-Party Vote Share Predictions

```{r state_sim_histograms}
selectInput("state", 
            "State:",
            sims %>% pull(state) %>% unique() %>% sort())
renderPlotly(
  pv2p_plot(input$state)
)
```



State-Level Results
=================================================

### State-Level Error

```{r error_scatterplot}

error <- pred_compare %>% 
  mutate(incorrect = ifelse(state %in% c("AZ", "NV", "GA"), TRUE, FALSE)) %>% 
  ggplot(aes(pred_pv2p, actual_pv2p,
             text = paste0("Biden Overperformed in ", state, " by ", round(diff, 3), "%"),
             color = diff, shape = incorrect)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  labs(y = "Actual Two-Party Popular Vote Share",
       title = "State-Level Model Error",
       x = "Predicted Two-Party Popular Vote Share",
       color = "Error = \nActual - Predicted",
       shape = "Incorrect Prediction?") +
  theme_hodp() +
  scale_color_gradient2(low = "#BE1E26", mid = "#E2DDDB", high = "#4B5973")

renderPlotly(
  ggplotly(error, tooltip = c("text", "x", "y", "shape"))
)

```

Row
-------------------------------------------------

### Changes Over Time

```{r change_linegraph}

selectInput("line_state", 
            "State:",
            sims %>% pull(state) %>% unique() %>% sort())

renderPlotly(
  
  ggplotly(changes %>% 
    filter(state == input$line_state) %>% 
    ggplot(aes(timestamp, pv2p, color = candidate,
               text = paste0(candidate, " had ", round(pv2p * 100, 3), 
                             "% of the vote share on ", timestamp,
                             " in ", state),
               group = candidate)) +
    geom_line() +
    geom_hline(yintercept = state_pred_pv2p(input$line_state, "biden"), linetype = "dashed", color = my_blue) +
    geom_hline(yintercept = state_pred_pv2p(input$line_state, "trump"), linetype = "dashed", color = my_red) +
    labs(y = "Two-Party Popular Vote Share",
         title = "",
         x = "",
         color = "Candidate",
         shape = "Incorrect Prediction?") +
    theme_hodp() +
    scale_color_manual(breaks = c("Biden", "Trump"),
                       values = c(my_blue, my_red)),
  tooltip = "text")
  
)


```

